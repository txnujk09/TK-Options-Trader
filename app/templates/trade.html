<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Chain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/">Home</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="/portfolio">Portfolio</a></li>
                <li class="nav-item"><a class="nav-link" href="/trade">Trade</a></li>
                <li class="nav-item"><a class="nav-link" href="/mc_greeks">Option Greeks</a></li>
                <li class="nav-item"><a class="nav-link" href="/market-trends">Market Trends</a></li>
                <li class="nav-item"><a class="nav-link" href="/order_history">Order History</a></li>
                <li class="nav-item"><a class="nav-link" href="/trade_history">Trade History</a></li>
            </ul>
        </div>
    </nav>
    <div class="container mt-5">
        <h2>Yahoo Finance Options Chain</h2>
        <label for="symbol" class="form-label">Enter Stock Symbol:</label>
        <input type="text" id="symbol" class="form-control" placeholder="e.g. PLTR">
    </div>
    <div class="container mt-3">
        <button class="btn btn-primary" onclick="fetchOptions()">Get Options</button>
    </div>

    <div id="options-result" class="container mt-5"></div>

    <script>
        function onConfirmBuy(button) {
            console.log("onConfirmBuy")

            // Get the row asscociated with the button
            let row = button.closest("tr");
            // Get column headers - this will give all table headers
            let table_headers = Array.from(document.querySelectorAll("#OptionsTable thead th")).map(th => th.innerText);

            // Get row values associated with the button
            let row_values = Array.from(row.querySelectorAll("td")).map(td => td.innerText);

            // Remove the last 2 values (Buy button and Sell button columns)
            row_values.pop();
            row_values.pop();

            // Convert to dictionary
            let rowDictionary = {};
            table_headers.slice(0, 8).forEach((key, index) => {
                console.log(key, index, row_values[index])
                rowDictionary[key] = row_values[index];
            });

            rowDictionary['Trade_type'] = 'BUY'
            fetch('/place_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rowDictionary)
            })
            .then(response => response.json())
            .then(data => console.log("Response from server:", data))
            .catch(error => console.error("Error:", error));
        }
    </script>

    <script>
        function onConfirmSell(button) {
            // Get the row asscociated with the button
            let row = button.closest("tr");
            // Get column headers - this will give all table headers
            let table_headers = Array.from(document.querySelectorAll("#OptionsTable thead th")).map(th => th.innerText);

            // Get row values associated with the button
            let row_values = Array.from(row.querySelectorAll("td")).map(td => td.innerText);

            // Remove the last 2 values (Buy button and Sell button columns)
            row_values.pop();
            row_values.pop();

            // Convert to dictionary
            let rowDictionary = {};
            table_headers.slice(0, 8).forEach((key, index) => {
                console.log(key, index, row_values[index])
                rowDictionary[key] = row_values[index];
            });

            rowDictionary['Trade_type'] = 'SELL'
            fetch('/place_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rowDictionary)
            })
            .then(response => response.json())
            .then(data => console.log("Response from server:", data))
            .catch(error => console.error("Error:", error));
        }
    </script>

    <script>
        function fetchOptions() {
            let symbol = document.getElementById('symbol').value.trim().toUpperCase();
            if (!symbol) {
                alert("Please enter a stock symbol.");
                return;
            }

            fetch(`/options?symbol=${symbol}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('options-result').innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }

                    let resultHTML = `<h4>Options Chain for ${data.symbol}</h4>`;

                    data.expirations.forEach(expiration => {
                        let chain = data.options_chain[expiration];
                        console.log("Hello")
                        console.log(chain)

                        resultHTML += `<h5>Expiration: ${expiration}</h5>`;
                        resultHTML += `
                            <table class="table table-bordered" id="OptionsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Type</th>
                                        <th>StockSymbol</th>
                                        <th>Bid</th>
                                        <th>Ask</th>
                                        <th>Strike</th>
                                        <th>Last Price</th>
                                        <th>Open Interest</th>
                                        <th>Volume</th>
                                        <th>BUY</th>
                                        <th>SELL</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        if (chain && chain.calls) {
                            if (chain.calls.length > 0) {
                                chain.calls.forEach(option => {
                                    resultHTML += `
                                        <tr>
                                            <td class="text-success">Call</td>
                                            <td>${option.contractSymbol || 'N/A'}</td>
                                            <td>${option.bid || 'N/A'}</td>
                                            <td>${option.ask || 'N/A'}</td>
                                            <td>${option.strike}</td>
                                            <td>${option.lastPrice || 'N/A'}</td>
                                            <td>${option.openInterest || 'N/A'}</td>
                                            <td>${option.volume || 'N/A'}</td>
                                            <td><button class="btn btn-primary" onclick="onConfirmBuy(this)">Buy</button></td>
                                            <td><button class="btn btn-success" onclick="onConfirmSell(this)">Sell</button></td>
                                        </tr>
                                    `;
                                });
                            }
                        } else {
                            resultHTML += `<tr><td colspan="7" class="text-center">No Call Options Available</td></tr>`;
                        }

                        if (chain && chain.puts && chain.puts.length > 0) {
                            chain.puts.forEach(option => {
                                resultHTML += `
                                    <tr>
                                        <td class="text-danger">Put</td>
                                        <td>${option.contractSymbol || 'N/A'}</td>
                                        <td>${option.bid || 'N/A'}</td>
                                        <td>${option.ask || 'N/A'}</td>
                                        <td>${option.strike}</td>
                                        <td>${option.lastPrice || 'N/A'}</td>
                                        <td>${option.openInterest || 'N/A'}</td>
                                        <td>${option.volume || 'N/A'}</td>
                                        <td><button class="btn btn-primary" onclick="onConfirmBuy(this)">Buy</button></td>
                                        <td><button class="btn btn-success" onclick="onConfirmSell(this)">Sell</button></td>
                                    </tr>
                                `;
                            });
                        } else {
                            resultHTML += `<tr><td colspan="7" class="text-center">No Put Options Available</td></tr>`;
                        }

                        resultHTML += `</tbody></table>`;
                    });

                    document.getElementById('options-result').innerHTML = resultHTML;
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    document.getElementById('options-result').innerHTML = `<p class="text-danger">Error fetching options data.</p>`;
                });
        }
    </script>

</body>
</html>