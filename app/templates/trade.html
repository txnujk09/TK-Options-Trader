<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo Finance Options Chain</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* shift 'Home' slightly to the right */
        .navbar-brand {
            margin-left: 10px;
        }

        /*align Portfolio, Trade, Options Calculator, Learn in the center */
        .navbar-nav.center-nav {
            margin: auto;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 10px;
            transform: translateX(-45px);
        }

        /* position History on the right */
        .history-dropdown {
            position: absolute;
            right: 20px;
        }

        /*Dropdown styling */
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            list-style: none;
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }

        /*Center content */
        .center-text {
            text-align: center;
            margin-top: 40px; /* Adjust spacing */
        }

        /* center all relevant content */
        .center-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 30vh; 
        }

            /* make input box smaller */
                .input-box {
            width: 200px;
        }

        /* add spacing to the button */
        .button-box {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/">Home</a>

        <!-- Centered Nav Links -->
        <div class="collapse navbar-collapse justify-content-center">
            <ul class="navbar-nav center-nav">
                <li class="nav-item"><a class="nav-link" href="/portfolio">Portfolio</a></li>
                <li class="nav-item"><a class="nav-link" href="/trade">Trade</a></li>
                <li class="nav-item"><a class="nav-link" href="/mc_greeks">Options Calculator</a></li>
                <li class="nav-item"><a class="nav-link" href="/learn">Learn</a></li>
            </ul>
        </div>

        <!--history Dropdown -->
        <div class="dropdown history-dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="historyDropdown">History</a> 
            <ul class="dropdown-menu" aria-labelledby="historyDropdown">
                <li><a class="dropdown-item" href="/order_history">Order History</a></li>
                <li><a class="dropdown-item" href="/trade_history">Trade History</a></li>
            </ul>
        </div>
    </nav>           

    <!--center the title, input box, and button -->
    <div class="container center-content">
        <h1>Yahoo Finance Options Chain</h1>
        <label for="symbol" class="form-label mt-3">Enter ticker:</label> <!--input box for user to enter stock symbol -->
        <input type="text" id="symbol" class="form-control input-box" placeholder="e.g. PLTR">
        <button class="btn btn-primary button-box" onclick="fetchOptions()">Get Options</button> <!--button to fetch options chain -->
    </div>

    <div id="options_result" class="container mt-5"></div> <!--display options chain -->

    <script>
        function onConfirmBuy(button) {
            console.log("onConfirmBuy")

            // Get the row asscociated with the button
            let row = button.closest("tr");
            // Get column headers - this will give all table headers
            let table_headers = Array.from(document.querySelectorAll("#OptionsTable thead th")).map(th => th.innerText);

            // Get row values associated with the button
            let row_values = Array.from(row.querySelectorAll("td")).map(td => td.innerText);

            // Remove the last 2 values (Buy button and Sell button columns)
            row_values.pop();
            row_values.pop();

            // Convert to dictionary
            let rowDictionary = {};
            table_headers.slice(0, 8).forEach((key, index) => { //slice to get only the first 8 columns
                console.log(key, index, row_values[index]) //print key, index, and value
                rowDictionary[key] = row_values[index]; //add key-value pair to dictionary
            });

            rowDictionary['Trade_type'] = 'BUY' //add trade type to dictionary
            fetch('/place_order', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json' //set content type to json
                },
                body: JSON.stringify(rowDictionary)
            })
            .then(response => response.json())
            .then(data => console.log("Response from server:", data)) //log response from server
            .catch(error => console.error("Error:", error));
        }
    </script>

    <script>
        function onConfirmSell(button) {
            // Get the row asscociated with the button
            let row = button.closest("tr");
            // Get column headers - this will give all table headers
            let table_headers = Array.from(document.querySelectorAll("#OptionsTable thead th")).map(th => th.innerText);

            // Get row values associated with the button
            let row_values = Array.from(row.querySelectorAll("td")).map(td => td.innerText);

            // Remove the last 2 values (Buy button and Sell button columns)
            row_values.pop();
            row_values.pop();

            // Convert to dictionary
            let rowDictionary = {};
            table_headers.slice(0, 8).forEach((key, index) => {
                console.log(key, index, row_values[index])
                rowDictionary[key] = row_values[index];
            });

            rowDictionary['Trade_type'] = 'SELL' //add trade type to dictionary
            fetch('/place_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(rowDictionary)
            })
            .then(response => response.json())
            .then(data => console.log("Response from server:", data)) //log response from server
            .catch(error => console.error("Error:", error));
        }
    </script>

    <script>
        function fetchOptions() {
            let symbol = document.getElementById('symbol').value.trim().toUpperCase(); //get stock symbol
            if (!symbol) {
                alert("Please enter a stock symbol.");
                return; //return if no symbol is entered
            }

            fetch(`/options?symbol=${symbol}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        //document.getElementById('options_result').innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }

                    let resultHTML = `<h4>Options Chain for ${data.symbol}</h4>`;

                    data.expirations.forEach(expiration => {
                        let chain = data.options_chain[expiration];
                        console.log("Hello")
                        //console.log(chain)

                        resultHTML += `<h5>Expiration: ${expiration}</h5>`; //display expiration date
                        resultHTML += `
                            <table class="table table-bordered" id="OptionsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Type</th>
                                        <th>StockSymbol</th>
                                        <th>Bid</th>
                                        <th>Ask</th>
                                        <th>Strike</th>
                                        <th>Last Price</th>
                                        <th>Open Interest</th>
                                        <th>Volume</th>
                                        <th>BUY</th>
                                        <th>SELL</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
 
                        if (chain && chain.calls) { //check if calls are available
                            if (chain.calls.length > 0) { //display call options
                                chain.calls.forEach(option => {
                                    resultHTML += `
                                        <tr>
                                            <td class="text-success">Call</td>
                                            <td>${option.contractSymbol || 'N/A'}</td> 
                                            <td>${option.bid || 'N/A'}</td>
                                            <td>${option.ask || 'N/A'}</td>
                                            <td>${option.strike}</td>
                                            <td>${option.lastPrice || 'N/A'}</td>
                                            <td>${option.openInterest || 'N/A'}</td>
                                            <td>${option.volume || 'N/A'}</td>
                                            <td><button class="btn btn-primary" onclick="onConfirmBuy(this)">Buy</button></td>
                                            <td><button class="btn btn-success" onclick="onConfirmSell(this)">Sell</button></td>
                                        </tr>
                                    `;
                                });
                            }
                        } else {
                            resultHTML += `<tr><td colspan="7" class="text-center">No Call Options Available</td></tr>`; //display if no call options are available
                        }

                        if (chain && chain.puts && chain.puts.length > 0) { //display put options
                            chain.puts.forEach(option => { //loop through put options 
                                resultHTML += ` 
                                    <tr>
                                        <td class="text-danger">Put</td> 
                                        <td>${option.contractSymbol || 'N/A'}</td> 
                                        <td>${option.bid || 'N/A'}</td>
                                        <td>${option.ask || 'N/A'}</td>
                                        <td>${option.strike}</td>
                                        <td>${option.lastPrice || 'N/A'}</td>
                                        <td>${option.openInterest || 'N/A'}</td>
                                        <td>${option.volume || 'N/A'}</td>
                                        <td><button class="btn btn-primary" onclick="onConfirmBuy(this)">Buy</button></td>
                                        <td><button class="btn btn-success" onclick="onConfirmSell(this)">Sell</button></td>
                                    </tr>
                                `;
                            });
                        } else {
                            resultHTML += `<tr><td colspan="7" class="text-center">No Put Options Available</td></tr>`;
                        }

                        resultHTML += `</tbody></table>`;
                    });
                    console.log("Hello Tanuj") //print Hello Tanuj
                    document.getElementById('options_result').innerHTML = resultHTML; //display options chain
                })
                .catch(error => { //catch error
                    console.error("Fetch error:", error);
                    //document.getElementById('options_result').innerHTML = `<p class="text-danger">Error fetching options data.</p>`;
                });
        }
    </script>


</body>
</html>

